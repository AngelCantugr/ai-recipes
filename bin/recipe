#!/usr/bin/env bash
# AI Recipes CLI - Quick access to prompt engineering recipes

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
RECIPE_DIRS=("appetizers" "mains" "sides" "desserts" "ingredients")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
usage() {
    cat << EOF
${CYAN}AI Recipes CLI${NC} - Quick access to prompt engineering recipes

${YELLOW}Usage:${NC}
  recipe <command> [arguments]

${YELLOW}Commands:${NC}
  ${GREEN}list${NC} [category]           List all recipes (or by category)
  ${GREEN}show${NC} <recipe-name>        Display a recipe
  ${GREEN}find${NC} <keyword>            Search recipes by keyword
  ${GREEN}copy${NC} <recipe-name>        Copy recipe to clipboard
  ${GREEN}edit${NC} <recipe-name>        Edit recipe in \$EDITOR
  ${GREEN}random${NC}                    Show a random recipe
  ${GREEN}categories${NC}                List all categories
  ${GREEN}docs${NC} [topic]              Browse learning documentation
  ${GREEN}help${NC}                      Show this help message

${YELLOW}Examples:${NC}
  recipe list                    # List all recipes
  recipe list mains              # List main course recipes
  recipe show code-exploration   # Display a specific recipe
  recipe find debugging          # Search for debugging-related recipes
  recipe copy one-pager          # Copy one-pager recipe to clipboard
  recipe docs fundamentals       # View prompt engineering fundamentals
  recipe random                  # Get inspired by a random recipe

${YELLOW}Integration:${NC}
  # Pipe directly to AI tools
  recipe show system-design | gh copilot explain
  recipe show code-review | pbcopy  # macOS clipboard

${YELLOW}Categories:${NC}
  appetizers - Quick start prompts (5-15 min)
  mains      - Substantial work (30min-4hr)
  sides      - Supporting tasks (15-60 min)
  desserts   - Finishing touches (10-30 min)
  ingredients- Reusable components

${YELLOW}Documentation:${NC}
  docs/prompt-engineering/  - Comprehensive guides
  docs/context-engineering/ - Context optimization
  docs/examples/            - Real-world examples
  docs/references/          - Glossary and resources

${CYAN}For more information, visit: https://github.com/yourusername/ai-recipes${NC}
EOF
}

# Find recipe file by name (fuzzy matching)
find_recipe_file() {
    local name="$1"
    local found=""

    for dir in "${RECIPE_DIRS[@]}"; do
        local dir_path="$REPO_DIR/$dir"
        if [ -d "$dir_path" ]; then
            # Try exact match first
            if [ -f "$dir_path/$name.md" ]; then
                echo "$dir_path/$name.md"
                return 0
            fi

            # Try subdirectories (for mains)
            for subdir in "$dir_path"/*; do
                if [ -d "$subdir" ] && [ -f "$subdir/$name.md" ]; then
                    echo "$subdir/$name.md"
                    return 0
                fi
            done

            # Try fuzzy match
            local matches=$(find "$dir_path" -name "*$name*.md" -type f)
            if [ -n "$matches" ]; then
                found="$matches"
            fi
        fi
    done

    if [ -n "$found" ]; then
        echo "$found" | head -n 1
        return 0
    fi

    return 1
}

# List all recipes
list_recipes() {
    local category="$1"

    if [ -n "$category" ]; then
        if [ ! -d "$REPO_DIR/$category" ]; then
            echo -e "${RED}Error: Category '$category' not found${NC}" >&2
            return 1
        fi
        echo -e "${CYAN}Recipes in '$category':${NC}\n"
        list_category "$category"
    else
        for dir in "${RECIPE_DIRS[@]}"; do
            if [ -d "$REPO_DIR/$dir" ]; then
                echo -e "${CYAN}${dir}:${NC}"
                list_category "$dir"
                echo ""
            fi
        done
    fi
}

list_category() {
    local dir="$1"
    local dir_path="$REPO_DIR/$dir"

    # Find all markdown files
    find "$dir_path" -name "*.md" -type f | while read -r file; do
        local name=$(basename "$file" .md)
        local title=$(grep -m 1 "^# " "$file" 2>/dev/null | sed 's/^# //' || echo "$name")
        local rel_path="${file#$REPO_DIR/}"

        # Get time estimate if available
        local time=$(grep -m 1 "Time:" "$file" 2>/dev/null | sed 's/.*Time: *//' | sed 's/ *|.*//' || echo "")

        if [ -n "$time" ]; then
            echo -e "  ${GREEN}$name${NC} - $title ${YELLOW}($time)${NC}"
        else
            echo -e "  ${GREEN}$name${NC} - $title"
        fi
    done | sort
}

# Show a recipe
show_recipe() {
    local name="$1"

    if [ -z "$name" ]; then
        echo -e "${RED}Error: Recipe name required${NC}" >&2
        echo "Usage: recipe show <recipe-name>" >&2
        return 1
    fi

    local file=$(find_recipe_file "$name")

    if [ -z "$file" ]; then
        echo -e "${RED}Error: Recipe '$name' not found${NC}" >&2
        echo "Try: recipe list" >&2
        return 1
    fi

    # Use bat if available, otherwise cat
    if command -v bat &> /dev/null; then
        bat --style=plain --color=always "$file"
    else
        cat "$file"
    fi
}

# Search recipes
search_recipes() {
    local keyword="$1"

    if [ -z "$keyword" ]; then
        echo -e "${RED}Error: Search keyword required${NC}" >&2
        echo "Usage: recipe find <keyword>" >&2
        return 1
    fi

    echo -e "${CYAN}Searching for '$keyword'...${NC}\n"

    for dir in "${RECIPE_DIRS[@]}"; do
        local dir_path="$REPO_DIR/$dir"
        if [ -d "$dir_path" ]; then
            grep -r -l -i "$keyword" "$dir_path" --include="*.md" 2>/dev/null | while read -r file; do
                local name=$(basename "$file" .md)
                local title=$(grep -m 1 "^# " "$file" 2>/dev/null | sed 's/^# //' || echo "$name")
                local category=$(basename "$(dirname "$file")")

                echo -e "${GREEN}$name${NC} (${YELLOW}$category${NC})"
                echo -e "  $title"

                # Show matching context
                grep -i "$keyword" "$file" -m 1 -B 0 -A 0 | sed 's/^/  ’ /'
                echo ""
            done
        fi
    done
}

# Copy recipe to clipboard
copy_recipe() {
    local name="$1"

    if [ -z "$name" ]; then
        echo -e "${RED}Error: Recipe name required${NC}" >&2
        echo "Usage: recipe copy <recipe-name>" >&2
        return 1
    fi

    local file=$(find_recipe_file "$name")

    if [ -z "$file" ]; then
        echo -e "${RED}Error: Recipe '$name' not found${NC}" >&2
        return 1
    fi

    # Try different clipboard commands
    if command -v pbcopy &> /dev/null; then
        cat "$file" | pbcopy
        echo -e "${GREEN}${NC} Recipe copied to clipboard (macOS)"
    elif command -v xclip &> /dev/null; then
        cat "$file" | xclip -selection clipboard
        echo -e "${GREEN}${NC} Recipe copied to clipboard (Linux)"
    elif command -v clip.exe &> /dev/null; then
        cat "$file" | clip.exe
        echo -e "${GREEN}${NC} Recipe copied to clipboard (WSL)"
    else
        echo -e "${YELLOW}Warning: No clipboard tool found${NC}" >&2
        echo "Recipe content:"
        cat "$file"
    fi
}

# Edit recipe
edit_recipe() {
    local name="$1"

    if [ -z "$name" ]; then
        echo -e "${RED}Error: Recipe name required${NC}" >&2
        echo "Usage: recipe edit <recipe-name>" >&2
        return 1
    fi

    local file=$(find_recipe_file "$name")

    if [ -z "$file" ]; then
        echo -e "${RED}Error: Recipe '$name' not found${NC}" >&2
        return 1
    fi

    ${EDITOR:-vim} "$file"
}

# Show random recipe
random_recipe() {
    local all_recipes=()

    for dir in "${RECIPE_DIRS[@]}"; do
        local dir_path="$REPO_DIR/$dir"
        if [ -d "$dir_path" ]; then
            while IFS= read -r file; do
                all_recipes+=("$file")
            done < <(find "$dir_path" -name "*.md" -type f)
        fi
    done

    if [ ${#all_recipes[@]} -eq 0 ]; then
        echo -e "${RED}Error: No recipes found${NC}" >&2
        return 1
    fi

    local random_file="${all_recipes[$RANDOM % ${#all_recipes[@]}]}"
    local name=$(basename "$random_file" .md)

    echo -e "${CYAN}Random recipe: ${GREEN}$name${NC}\n"
    show_recipe "$name"
}

# Browse documentation
browse_docs() {
    local topic="$1"
    local docs_dir="$REPO_DIR/docs"

    if [ -z "$topic" ]; then
        # List available documentation
        echo -e "${CYAN}Available Documentation:${NC}\n"
        echo -e "${GREEN}Prompt Engineering:${NC}"
        ls -1 "$docs_dir/prompt-engineering"/*.md 2>/dev/null | while read -r file; do
            local name=$(basename "$file" .md)
            local title=$(grep -m 1 "^# " "$file" 2>/dev/null | sed 's/^# //')
            echo "  $name - $title"
        done
        echo ""
        echo -e "${GREEN}Context Engineering:${NC}"
        ls -1 "$docs_dir/context-engineering"/*.md 2>/dev/null | while read -r file; do
            local name=$(basename "$file" .md)
            local title=$(grep -m 1 "^# " "$file" 2>/dev/null | sed 's/^# //')
            echo "  $name - $title"
        done
        echo ""
        echo -e "${GREEN}Examples & References:${NC}"
        find "$docs_dir/examples" "$docs_dir/references" -name "*.md" 2>/dev/null | while read -r file; do
            local name=$(basename "$file" .md)
            echo "  $name"
        done
        echo ""
        echo -e "${YELLOW}Usage:${NC} recipe docs <topic-name>"
        return 0
    fi

    # Find and show the documentation
    local doc_file=$(find "$docs_dir" -name "*$topic*.md" -type f | head -n 1)

    if [ -z "$doc_file" ]; then
        echo -e "${RED}Error: Documentation for '$topic' not found${NC}" >&2
        return 1
    fi

    if command -v bat &> /dev/null; then
        bat --style=plain --color=always "$doc_file"
    else
        cat "$doc_file"
    fi
}

# List categories
list_categories() {
    echo -e "${CYAN}Recipe Categories:${NC}\n"
    for dir in "${RECIPE_DIRS[@]}"; do
        if [ -d "$REPO_DIR/$dir" ]; then
            local count=$(find "$REPO_DIR/$dir" -name "*.md" -type f | wc -l)
            case "$dir" in
                appetizers)
                    echo -e "  ${GREEN}$dir${NC} ($count recipes) - Quick start prompts (5-15 min)"
                    ;;
                mains)
                    echo -e "  ${GREEN}$dir${NC} ($count recipes) - Substantial work (30min-4hr)"
                    ;;
                sides)
                    echo -e "  ${GREEN}$dir${NC} ($count recipes) - Supporting tasks (15-60 min)"
                    ;;
                desserts)
                    echo -e "  ${GREEN}$dir${NC} ($count recipes) - Finishing touches (10-30 min)"
                    ;;
                ingredients)
                    echo -e "  ${GREEN}$dir${NC} ($count recipes) - Reusable components"
                    ;;
            esac
        fi
    done
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        list|ls)
            list_recipes "$@"
            ;;
        show|cat|view)
            show_recipe "$@"
            ;;
        find|search|grep)
            search_recipes "$@"
            ;;
        copy|cp)
            copy_recipe "$@"
            ;;
        edit|vim)
            edit_recipe "$@"
            ;;
        random|rand)
            random_recipe
            ;;
        categories|cats)
            list_categories
            ;;
        docs|doc|learn)
            browse_docs "$@"
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            echo -e "${RED}Error: Unknown command '$command'${NC}" >&2
            echo "" >&2
            usage >&2
            return 1
            ;;
    esac
}

main "$@"
